# 機能一覧

このページでは、`my-confluence-mcp` が提供する機能を「何ができるのか / どう使うのか / どんな点に注意すべきか」という観点で整理します。  

※本プロジェクトは **読み取り専用** のMCPサーバーです。Confluenceの更新系操作は行いません。

---

## Confluence内のページ検索（CQL検索）

### できること
- Confluence内のページを **CQL（Confluence Query Language）** を使って検索できます。
- “キーワード検索”だけでなく、CQLで条件を組み合わせた検索（例：スペース指定、タイトル条件、更新日条件など）ができます。
- 検索結果は、AIが扱いやすい形で「候補一覧」として返します（ページを特定するための情報が含まれます）。

### 使い方（イメージ）
- AI（Copilotなど）に「Confluenceで◯◯を探して」と依頼すると、内部的に検索ツールが実行されます。
- より正確に絞り込みたい場合は、CQLの条件（スペース・タイトル・ラベルなど）を意識した依頼が有効です。

### デフォルトCQL（環境変数 `CONFLUENCE_DEFAULT_CQL`）
検索時に「必ず適用したいCQL」を、環境変数として固定できます。  
これにより、ツール利用者（AIやユーザー）が入力したCQLに関わらず、常に組織ルールに沿った絞り込み（例：特定スペースのみ、ページのみ、機密ラベル除外など）を強制できます。

- 設定方法（例）
  ```env
  "CONFLUENCE_DEFAULT_CQL": "space = SAMPLE AND type = page AND status = current"
  ```

* 実際の検索では、概ね次のように合成されます（概念図）

  ```text
  (<default_cql>) AND (<user_cql>)
  ```

  なお、ユーザーのCQLに `ORDER BY` が含まれている場合は、**`ORDER BY` はユーザー側を優先して末尾に保持** します（例：`ORDER BY lastmodified DESC`）。

#### 良い例（推奨）

“常に適用したいフィルタ条件”だけをデフォルトに寄せるのが基本です。

* 特定スペースに固定して、AIの検索ブレを抑える

  ```env
  "CONFLUENCE_DEFAULT_CQL": "space = SAMPLE"
  ```

  ユーザー入力（例）:

  ```cql
  text ~ "手順書" ORDER BY lastmodified DESC
  ```

  合成イメージ:

  ```cql
  (space = DVA) AND (text ~ "手順書") ORDER BY lastmodified DESC
  ```

* 「ページのみ」「現行のみ」などの安全な共通条件を強制する

  ```env
  "CONFLUENCE_DEFAULT_CQL": "type = page AND status = current"
  ```

* 機密ラベルを除外（運用に合わせて）

  ```env
  "CONFLUENCE_DEFAULT_CQL": "label != secret AND label != confidential"
  ```

#### 悪い例（避けたい）

デフォルトCQLは“常に強制される”ため、入れ方を誤ると検索体験が壊れやすいです。

* `ORDER BY` をデフォルトに入れてしまう
  デフォルト側に `ORDER BY` を含めると、ユーザーCQLの `ORDER BY` と衝突・二重化しやすく、意図しないクエリになりがちです。

  ```env
  # 悪い例
  "CONFLUENCE_DEFAULT_CQL": "space = DVA ORDER BY lastmodified DESC"
  ```

* “強すぎる絞り込み”をデフォルトに入れてしまう
  例：特定ラベル必須、特定タイトル必須などは、検索ヒットが極端に減って「検索できない」に見えやすいです。

  ```env
  # 悪い例（運用上の狙いがない限り避ける）
  "CONFLUENCE_DEFAULT_CQL": "label = must-have-label"
  ```

* 長大なCQLを詰め込みすぎる
  CQLには長さ上限があり、デフォルトとユーザー入力を合成すると上限を超えて失敗することがあります（運用ルールは短く・要点だけにするのがおすすめです）。

  ```env
  # 悪い例（長すぎる/複雑すぎる）
  "CONFLUENCE_DEFAULT_CQL": "(...非常に長い条件...)"
  ```

### 出力（イメージ）
- 検索結果は **ページの候補一覧** として返ります。
- 候補が複数ある場合、ユーザーは「このページを開いて」といった形で次の「ページ内容の取得」に進めます。

### 注意点
- 検索の自由度は高い一方で、CQLの指定が曖昧だと候補が多くなりがちです。
- Confluence側の権限に依存します（閲覧権限がないページは取得できません）。
- `CONFLUENCE_DEFAULT_CQL` を設定している場合、検索は常にその条件で **追加フィルタ** されます（ユーザー入力だけでは解除できません）。
  「検索できない」「想定よりヒットが少ない」場合は、まずデフォルトCQLの条件を確認してください。

---

## ページ内容の取得（ページID指定）

### できること
- 検索結果などで得た **ページID** を指定して、対象ページの内容を取得できます。
- 取得できる情報の例：
  - ページのタイトル
  - ページ本文（主にHTML形式）
  - 付随情報（環境により取得できる範囲は変わります）

### 使い方（イメージ）
1. 検索でページ候補を見つける  
2. 「このページを開いて」「このページの内容を要約して」と依頼する  
3. AIがページ内容取得ツールを使って内容を取得し、要約や引用を返す

### 本文の扱い（重要）
- 取得する本文は長くなりがちなので、**本文長の上限**を設けて必要十分な範囲に絞って返します。

### 注意点
- ページ本文はHTMLを含む場合があります。AI側では必要に応じて整形・要約して利用します。
- 大規模ページの場合、上限により末尾が切り捨てられることがあります。

---

## 結果のMarkdown整形（AI向けに見やすく返す）

### できること
- Confluence APIの生データ（JSON）のままだと、人間にもAIにも読みづらくなりがちです。
- `my-confluence-mcp` では、検索結果やページ内容を **Markdownとして読みやすい形** に整形して返します。

### 整形例（イメージ）
- 検索結果：ページ候補を箇条書きで列挙（必要な識別情報が分かる形）
- ページ内容：タイトルやメタ情報 + 本文をコードブロック等で明示

### ねらい
- AIが「どのページを開くべきか」「どの部分を根拠として回答すべきか」を判断しやすくする
- ユーザーが「どれを開けば良いか」を選びやすくする

### 注意点
- 整形は“読みやすさ”を優先します。必要に応じて、AI側でさらに要約や抽出が行われます。

---

## Confluence Cloud・オンプレ両対応

### できること
- **Confluence Cloud** と **Confluence on-prem（Data Center / Server）** の両方で動作する設計です。
- APIや認証方式の違いを吸収し、同じツール（検索 / 内容取得）として利用できるようにしています。

### 設定の考え方（代表例）
- 接続先種別：`CONFLUENCE_HOSTING`
  - Cloud: `cloud`
  - On-prem: `onprem`
- 接続先URL：`CONFLUENCE_BASE_URL`
  - Cloud例：`https://your-domain.atlassian.net/wiki`
  - On-prem例：`https://confluence.example.com`
- 認証情報：
  - Cloud：メール + APIトークン（Basic認証相当で扱う）
  - On-prem：PAT（利用できる場合）または同等の方式

### 注意点
- オンプレ環境は構成差分が出やすい（リバプロ、パス、証明書など）ため、接続できない場合はまず `CONFLUENCE_BASE_URL` とネットワーク到達性を確認してください。
- Cloud/オンプレで取得できる情報の範囲やレスポンス形式が微妙に異なることがあります（本プロジェクト側で可能な範囲は吸収します）。

---

## 読み取り専用（安全性重視）

### できること（= しないこと）
- 本プロジェクトが提供するのは **検索** と **取得** のみです。
- ページの作成・更新・削除など、Confluenceに影響を与える操作は行いません。

### 注意点
- 読み取り専用でも「見えるものは見える」ため、トークンの権限設計とConfluence側のアクセス制御が重要です。
- 取得結果をAIが扱う都合上、機密情報が含まれるページへのアクセス権を持たせすぎないようにしてください。
